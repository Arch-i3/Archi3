#!/usr/bin/env sh
# Disk usage block with toggleable details on left click + pcmanfm on right click

DIR="${DIR:-$BLOCK_INSTANCE}"
DIR="${DIR:-$HOME}"
ALERT_LOW="${ALERT_LOW:-$1}"
ALERT_LOW="${ALERT_LOW:-10}" # default threshold (not used for color now)

LOCAL_FLAG="-l"
if [ "$1" = "-n" ] || [ "$2" = "-n" ]; then
    LOCAL_FLAG=""
fi

# Toggle állapotfájl
STATE_FILE="/tmp/i3blocks_disk_toggle"

# Bal kattintásra váltás
if [ "$BLOCK_BUTTON" = "1" ]; then
    if [ -f "$STATE_FILE" ]; then
        rm "$STATE_FILE"
    else
        touch "$STATE_FILE"
    fi
fi

# Jobb kattintásra pcmanfm megnyitása
if [ "$BLOCK_BUTTON" = "3" ]; then
    pcmanfm "$DIR" &
fi

DETAILS=0
[ -f "$STATE_FILE" ] && DETAILS=1

if [ "$DETAILS" -eq 1 ]; then
    # részletes nézet
    df -h -P $LOCAL_FLAG "$DIR" | awk -v label="$LABEL" '
    /\/.*/ {
        print label "Used: " $3 " / Total: " $2 " (" $5 ")"
        use=$5
        exit 0
    }
    END {
        gsub(/%$/,"",use)
        if (use >= 105) {
            print "#8b4513"   # kritikus szín
        } else {
            print "#93a1a1"   # alapértelmezett szín
        }
    }'
else
    # alapértelmezett rövid nézet: csak a fennmaradó szabad hely
    df -h -P $LOCAL_FLAG "$DIR" | awk -v label="$LABEL" '
    /\/.*/ {
        print label $4   # full text
        print label $4   # short text
        use=$5
        exit 0
    }
    END {
        gsub(/%$/,"",use)
        if (use >= 105) {
            print "#8b4513"   # kritikus szín
        } else {
            print "#93a1a1"   # alapértelmezett szín
        }
    }'
fi
